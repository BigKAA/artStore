version: '3.8'

services:
  query-module:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: artstore_query_module
    ports:
      - "8030:8030"
    environment:
      # Application
      APP_NAME: query-module
      DEBUG: "false"
      LOG_LEVEL: INFO
      LOG_FORMAT: json  # ОБЯЗАТЕЛЬНО json для production

      # Database (PostgreSQL) - подключение к внешней инфраструктуре
      DATABASE_HOST: localhost
      DATABASE_PORT: 5432
      DATABASE_USERNAME: artstore
      DATABASE_PASSWORD: password
      DATABASE_DATABASE: artstore
      DATABASE_POOL_SIZE: 20
      DATABASE_MAX_OVERFLOW: 10

      # Redis (SYNC режим) - подключение к внешней инфраструктуре
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      REDIS_DB: 2  # Отдельная DB для Query Module
      REDIS_PASSWORD: ""

      # Cache settings
      CACHE_LOCAL_ENABLED: "true"
      CACHE_LOCAL_TTL: 300
      CACHE_REDIS_ENABLED: "true"
      CACHE_REDIS_TTL: 1800

      # Search settings
      SEARCH_DEFAULT_LANGUAGE: russian
      SEARCH_MAX_RESULTS: 100

      # Download settings
      DOWNLOAD_CONNECT_TIMEOUT: 10
      DOWNLOAD_READ_TIMEOUT: 300
      DOWNLOAD_MAX_CONNECTIONS: 100

      # JWT Authentication
      AUTH_PUBLIC_KEY_PATH: /app/keys/public_key.pem
      AUTH_ALGORITHM: RS256

    volumes:
      # JWT public key (shared с Admin Module)
      - ../admin-module/keys/public_key.pem:/app/keys/public_key.pem:ro
      # Логи (optional, для debugging)
      - ./logs:/app/logs

    network_mode: host  # Для доступа к localhost инфраструктуре

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
