# Kubernetes Deployment для ArtStore Admin Module
#
# Этот манифест демонстрирует полный Deployment с использованием Secrets
# через volume mounts для Platform-Agnostic Secret Management.
#
# Prerequisites:
#   1. Создать namespace: kubectl create namespace artstore
#   2. Создать Secrets: kubectl apply -f kubernetes-secrets.yaml
#   3. Deploy приложение: kubectl apply -f kubernetes-deployment.yaml
#
# Проверка:
#   kubectl get deployments -n artstore
#   kubectl get pods -n artstore
#   kubectl logs -f deployment/admin-module -n artstore

apiVersion: apps/v1
kind: Deployment
metadata:
  name: admin-module
  namespace: artstore
  labels:
    app: artstore
    component: admin-module
    version: v0.1.0
spec:
  replicas: 3  # High Availability - минимум 3 реплики

  selector:
    matchLabels:
      app: artstore
      component: admin-module

  # Rolling Update Strategy для zero-downtime deployments
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  template:
    metadata:
      labels:
        app: artstore
        component: admin-module
        version: v0.1.0
      annotations:
        # Prometheus scraping
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"

    spec:
      # Service Account для RBAC
      serviceAccountName: artstore-admin-sa

      # Security Context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      # Init Container для database migrations
      initContainers:
        - name: migrate-database
          image: artstore/admin-module:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Running database migrations..."
              alembic upgrade head
              echo "Migrations completed successfully"

          env:
            # Database settings из ConfigMap
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: artstore-admin-config
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: artstore-admin-config
                  key: DB_PORT
            - name: DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: artstore-admin-config
                  key: DB_USERNAME
            - name: DB_DATABASE
              valueFrom:
                configMapKeyRef:
                  name: artstore-admin-config
                  key: DB_DATABASE

            # Database password из Secret
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: artstore-admin-secrets
                  key: DB_PASSWORD

      # Main Application Container
      containers:
        - name: admin-module
          image: artstore/admin-module:latest
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
            - name: metrics
              containerPort: 8000
              protocol: TCP

          # Environment Variables из ConfigMap
          envFrom:
            - configMapRef:
                name: artstore-admin-config

          # Sensitive Environment Variables из Secret (alternative approach)
          env:
            # Database password
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: artstore-admin-secrets
                  key: DB_PASSWORD

            # Redis password
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: artstore-admin-secrets
                  key: REDIS_PASSWORD

          # Volume Mounts для Kubernetes Secrets (Platform-Agnostic approach)
          volumeMounts:
            # Монтирование секретов как файлы (preferred для SecretProvider)
            - name: secrets
              mountPath: /var/run/secrets/artstore
              readOnly: true

          # Resource Limits и Requests
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi

          # Liveness Probe - проверка жизнеспособности контейнера
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          # Readiness Probe - готовность принимать трафик
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          # Startup Probe - проверка успешного старта (для медленных стартов)
          startupProbe:
            httpGet:
              path: /health/live
              port: http
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 12  # 60 секунд на старт (12 * 5s)

          # Security Context для контейнера
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false  # False потому что alembic нужна запись
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

      # Volumes
      volumes:
        # Kubernetes Secrets volume (монтируется как файлы)
        - name: secrets
          secret:
            secretName: artstore-admin-secrets
            # Опционально: выбрать только нужные ключи
            items:
              - key: SECURITY_AUDIT_HMAC_SECRET
                path: SECURITY_AUDIT_HMAC_SECRET
              - key: JWT_PRIVATE_KEY
                path: JWT_PRIVATE_KEY
              - key: JWT_PUBLIC_KEY
                path: JWT_PUBLIC_KEY

      # Affinity Rules для распределения по нодам (High Availability)
      affinity:
        # Pod Anti-Affinity - разносить реплики по разным нодам
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - admin-module
                topologyKey: kubernetes.io/hostname

      # Tolerations для специальных нод (опционально)
      # tolerations:
      #   - key: "app"
      #     operator: "Equal"
      #     value: "artstore"
      #     effect: "NoSchedule"

      # DNS Policy
      dnsPolicy: ClusterFirst

      # Restart Policy
      restartPolicy: Always

      # Termination Grace Period
      terminationGracePeriodSeconds: 30

---
# Service для доступа к Admin Module
apiVersion: v1
kind: Service
metadata:
  name: admin-module-service
  namespace: artstore
  labels:
    app: artstore
    component: admin-module
  annotations:
    # Prometheus scraping annotations
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP  # Внутренний доступ, используйте Ingress для внешнего

  selector:
    app: artstore
    component: admin-module

  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: http
    - name: metrics
      protocol: TCP
      port: 8000
      targetPort: metrics

  sessionAffinity: None

---
# ServiceAccount для RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: artstore-admin-sa
  namespace: artstore
  labels:
    app: artstore
    component: admin-module

---
# HorizontalPodAutoscaler для автоматического масштабирования
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: admin-module-hpa
  namespace: artstore
  labels:
    app: artstore
    component: admin-module
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: admin-module

  minReplicas: 3
  maxReplicas: 10

  metrics:
    # CPU-based scaling
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

    # Memory-based scaling
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 5 минут перед scale down
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0  # Немедленный scale up
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60

---
# PodDisruptionBudget для High Availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: admin-module-pdb
  namespace: artstore
  labels:
    app: artstore
    component: admin-module
spec:
  minAvailable: 2  # Минимум 2 реплики всегда доступны

  selector:
    matchLabels:
      app: artstore
      component: admin-module

---
# Примечания:
#
# 1. Secret Volume Mounting:
#    Secrets монтируются как файлы в /var/run/secrets/artstore/
#    SecretProvider автоматически обнаруживает это и использует файловый режим
#
# 2. Environment Variables Alternative:
#    Можно использовать env vars вместо volume mounts, но volume mounts
#    предпочтительнее для:
#    - Автоматического обновления при изменении Secret
#    - Безопасности (не видны в kubectl describe pod)
#
# 3. High Availability:
#    - Minimum 3 replicas
#    - Pod Anti-Affinity (разные ноды)
#    - PodDisruptionBudget (минимум 2 доступны)
#    - HPA (автомасштабирование 3-10)
#    - RTO < 15 секунд (liveness probe failover)
#
# 4. Ingress Setup (опционально):
#    kubectl apply -f kubernetes-ingress.yaml
#
# 5. Мониторинг:
#    - Prometheus scraping через annotations
#    - Metrics endpoint: http://admin-module-service:8000/metrics
#    - Health checks: /health/live, /health/ready
