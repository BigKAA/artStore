# Docker Compose Deployment Example с Environment Variables для Secrets
#
# Этот файл демонстрирует как использовать environment variables для передачи
# секретных данных в контейнер Admin Module.
#
# ВАЖНО: В production используйте Docker Secrets или подобные механизмы
# для безопасного хранения секретов, а не plain text environment variables.
#
# Usage:
#   docker-compose -f docker-compose.secrets.yml up -d

version: '3.8'

services:
  admin-module:
    image: artstore/admin-module:latest
    container_name: artstore-admin-module

    ports:
      - "8000:8000"

    environment:
      # Application settings
      APP_NAME: "ArtStore Admin Module"
      APP_VERSION: "0.1.0"
      APP_DEBUG: "false"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8000"
      ENVIRONMENT: "production"

      # Database settings
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_USERNAME: "artstore"
      DB_PASSWORD: "${DB_PASSWORD:-password}"  # Из .env файла или default
      DB_DATABASE: "artstore_admin"

      # Redis settings
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"

      # JWT Settings - файловые пути (traditional)
      JWT_ALGORITHM: "RS256"
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: "7"
      JWT_PRIVATE_KEY_PATH: "/app/keys/private_key.pem"
      JWT_PUBLIC_KEY_PATH: "/app/keys/public_key.pem"
      JWT_KEY_ROTATION_HOURS: "24"

      # Alternative: Direct PEM content через environment variables
      # Раскомментируйте если хотите передавать ключи напрямую
      # (Kubernetes-style даже в Docker Compose)
      # JWT_PRIVATE_KEY: |
      #   -----BEGIN RSA PRIVATE KEY-----
      #   MIIEpAIBAAKCAQEA...
      #   -----END RSA PRIVATE KEY-----
      # JWT_PUBLIC_KEY: |
      #   -----BEGIN PUBLIC KEY-----
      #   MIIBIjANBgkqhkiG9w0BAQEF...
      #   -----END PUBLIC KEY-----

      # Security Settings
      SECURITY_AUDIT_HMAC_SECRET: "${AUDIT_HMAC_SECRET:-change-me-in-production-to-secure-random-value-min-32-chars}"
      SECURITY_AUDIT_RETENTION_DAYS: "2555"  # 7 years

      # CORS Settings
      CORS_ENABLED: "true"
      CORS_ALLOW_ORIGINS: '["http://localhost:4200", "https://artstore.example.com"]'
      CORS_ALLOW_CREDENTIALS: "true"

      # Logging
      LOG_LEVEL: "INFO"
      LOG_FORMAT: "json"  # ОБЯЗАТЕЛЬНО json для production

      # Monitoring
      PROMETHEUS_ENABLED: "true"
      OPENTELEMETRY_ENABLED: "true"
      OPENTELEMETRY_SERVICE_NAME: "artstore-admin-module"
      OPENTELEMETRY_EXPORTER_ENDPOINT: "http://otel-collector:4317"

      # Service Discovery
      SERVICE_DISCOVERY_ENABLED: "true"
      SERVICE_DISCOVERY_REDIS_CHANNEL: "artstore:service_discovery"

      # Scheduler
      SCHEDULER_ENABLED: "true"
      SCHEDULER_JWT_ROTATION_ENABLED: "true"
      SCHEDULER_JWT_ROTATION_INTERVAL_HOURS: "24"

    volumes:
      # Монтирование JWT ключей (если используете файловый подход)
      - ./keys:/app/keys:ro

      # Опционально: монтирование config.yaml если нужен
      # - ./config.yaml:/app/config.yaml:ro

    networks:
      - artstore-network

    depends_on:
      - postgres
      - redis

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/live"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15-alpine
    container_name: artstore-postgres

    environment:
      POSTGRES_USER: "artstore"
      POSTGRES_PASSWORD: "${DB_PASSWORD:-password}"
      POSTGRES_DB: "artstore_admin"

    volumes:
      - postgres-data:/var/lib/postgresql/data

    networks:
      - artstore-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U artstore"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: artstore-redis

    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

    volumes:
      - redis-data:/data

    networks:
      - artstore-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

networks:
  artstore-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
