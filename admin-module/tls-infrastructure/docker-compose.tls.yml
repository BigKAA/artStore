version: '3.8'

# Docker Compose configuration для TLS 1.3 + mTLS deployment
# Sprint 16 Phase 4: TLS 1.3 + mTLS Infrastructure
#
# Демонстрирует:
# - TLS 1.3 encryption для всех HTTP connections
# - mTLS (Mutual TLS) для inter-service authentication
# - Certificate mounting из tls-infrastructure директории
# - Secure environment variable configuration
#
# Prerequisites:
# 1. Generate certificates: cd tls-infrastructure && ./generate-certs.sh development
# 2. Verify certificates exist in tls-infrastructure/ca/, server-certs/, client-certs/
# 3. Update .env file с TLS configuration
#
# Usage:
#   docker-compose -f docker-compose.tls.yml up --build

services:
  # ============================================
  # Admin Module - HTTPS with mTLS server validation
  # ============================================
  admin-module:
    build:
      context: ..
      dockerfile: admin-module/Dockerfile
    container_name: artstore_admin_tls
    ports:
      - "8000:8000"
    environment:
      # App Configuration
      APP_DEBUG: "false"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8000"

      # Database
      DATABASE_HOST: "postgres"
      DATABASE_PORT: "5432"
      DATABASE_USERNAME: "artstore"
      DATABASE_PASSWORD: "password"
      DATABASE_DATABASE: "artstore"

      # Redis
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

      # Logging
      LOG_LEVEL: "INFO"
      LOG_FORMAT: "json"

      # TLS 1.3 Configuration
      TLS_ENABLED: "true"
      TLS_CERT_FILE: "/app/tls/server-cert.pem"
      TLS_KEY_FILE: "/app/tls/server-key.pem"
      TLS_CA_CERT_FILE: "/app/tls/ca-cert.pem"
      TLS_PROTOCOL_VERSION: "TLSv1.3"
      TLS_CIPHERS: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
      TLS_VERIFY_MODE: "CERT_REQUIRED"  # Require client certificates для mTLS

      # CORS Configuration
      CORS_ENABLED: "true"
      CORS_ALLOW_ORIGINS: '["https://localhost:4200"]'
      CORS_ALLOW_CREDENTIALS: "true"

      # Environment (для валидации security warnings)
      ENVIRONMENT: "development"

    volumes:
      # Mount server certificates
      - ./tls-infrastructure/server-certs/admin-module/server-cert.pem:/app/tls/server-cert.pem:ro
      - ./tls-infrastructure/server-certs/admin-module/server-key.pem:/app/tls/server-key.pem:ro
      - ./tls-infrastructure/ca/ca-cert.pem:/app/tls/ca-cert.pem:ro

    networks:
      - artstore_network
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "--cacert", "/app/tls/ca-cert.pem", "https://localhost:8000/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Storage Element - HTTPS with mTLS server validation
  # ============================================
  storage-element:
    build:
      context: ..
      dockerfile: storage-element/Dockerfile
    container_name: artstore_storage_tls
    ports:
      - "8010:8010"
    environment:
      # App Configuration
      APP_DEBUG: "false"
      APP_MODE: "rw"  # read-write mode

      # Server
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "8010"

      # Database
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_USERNAME: "artstore"
      DB_PASSWORD: "password"
      DB_DATABASE: "artstore"
      DB_TABLE_PREFIX: "storage_elem_01"

      # Redis
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

      # Storage
      STORAGE_TYPE: "local"
      STORAGE_LOCAL_BASE_PATH: "/data/storage"
      STORAGE_MAX_SIZE_GB: "10"

      # Logging
      LOG_LEVEL: "INFO"
      LOG_FORMAT: "json"

      # TLS 1.3 Configuration
      TLS_ENABLED: "true"
      TLS_CERT_FILE: "/app/tls/server-cert.pem"
      TLS_KEY_FILE: "/app/tls/server-key.pem"
      TLS_CA_CERT_FILE: "/app/tls/ca-cert.pem"
      TLS_PROTOCOL_VERSION: "TLSv1.3"
      TLS_CIPHERS: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
      TLS_VERIFY_MODE: "CERT_REQUIRED"  # Require client certificates для mTLS

      # CORS Configuration
      CORS_ENABLED: "true"
      CORS_ALLOW_ORIGINS: '["https://localhost:4200", "https://localhost:8000"]'

      ENVIRONMENT: "development"

    volumes:
      # Mount server certificates
      - ./tls-infrastructure/server-certs/storage-element/server-cert.pem:/app/tls/server-cert.pem:ro
      - ./tls-infrastructure/server-certs/storage-element/server-key.pem:/app/tls/server-key.pem:ro
      - ./tls-infrastructure/ca/ca-cert.pem:/app/tls/ca-cert.pem:ro

      # Storage data
      - storage_data:/data/storage
      - wal_data:/data/wal

    networks:
      - artstore_network
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "--cacert", "/app/tls/ca-cert.pem", "https://localhost:8010/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Ingester Module - HTTPS with mTLS client certificate
  # ============================================
  ingester-module:
    build:
      context: ..
      dockerfile: ingester-module/Dockerfile
    container_name: artstore_ingester_tls
    ports:
      - "8020:8020"
    environment:
      # App Configuration
      APP_DEBUG: "false"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8020"

      # Storage Element
      STORAGE_ELEMENT_BASE_URL: "https://storage-element:8010"  # HTTPS URL
      STORAGE_ELEMENT_TIMEOUT: "30"
      STORAGE_ELEMENT_CONNECTION_POOL_SIZE: "100"

      # Redis
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

      # Logging
      LOG_LEVEL: "INFO"
      LOG_FORMAT: "json"

      # TLS 1.3 Configuration (server mode для incoming requests)
      TLS_ENABLED: "true"
      TLS_CERT_FILE: "/app/tls/server-cert.pem"
      TLS_KEY_FILE: "/app/tls/server-key.pem"
      TLS_CA_CERT_FILE: "/app/tls/ca-cert.pem"  # Для валидации storage-element server cert
      TLS_PROTOCOL_VERSION: "TLSv1.3"
      TLS_CIPHERS: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
      TLS_VERIFY_MODE: "CERT_OPTIONAL"  # Accept но не require client certs

      # CORS Configuration
      CORS_ENABLED: "true"
      CORS_ALLOW_ORIGINS: '["https://localhost:4200", "https://localhost:8000"]'

      ENVIRONMENT: "development"

    volumes:
      # Mount server certificates (для incoming HTTPS requests)
      - ./tls-infrastructure/server-certs/ingester-module/server-cert.pem:/app/tls/server-cert.pem:ro
      - ./tls-infrastructure/server-certs/ingester-module/server-key.pem:/app/tls/server-key.pem:ro

      # Mount client certificate (для outgoing mTLS requests к storage-element)
      - ./tls-infrastructure/client-certs/ingester-client/client-cert.pem:/app/tls/client-cert.pem:ro
      - ./tls-infrastructure/client-certs/ingester-client/client-key.pem:/app/tls/client-key.pem:ro

      # Mount CA certificate (для валидации storage-element server cert)
      - ./tls-infrastructure/ca/ca-cert.pem:/app/tls/ca-cert.pem:ro

    networks:
      - artstore_network
    depends_on:
      - redis
      - storage-element
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "--cacert", "/app/tls/ca-cert.pem", "https://localhost:8020/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Query Module - HTTPS with mTLS client certificate
  # ============================================
  query-module:
    build:
      context: ..
      dockerfile: query-module/Dockerfile
    container_name: artstore_query_tls
    ports:
      - "8030:8030"
    environment:
      # App Configuration
      APP_NAME: "query-module"
      DEBUG: "false"
      HOST: "0.0.0.0"
      PORT: "8030"

      # Database
      DATABASE_HOST: "postgres"
      DATABASE_PORT: "5432"
      DATABASE_USERNAME: "artstore"
      DATABASE_PASSWORD: "password"
      DATABASE_DATABASE: "artstore"

      # Redis
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

      # Logging
      LOG_LEVEL: "INFO"
      LOG_FORMAT: "json"

      # TLS 1.3 Configuration (server mode для incoming requests)
      TLS_ENABLED: "true"
      TLS_CERT_FILE: "/app/tls/server-cert.pem"
      TLS_KEY_FILE: "/app/tls/server-key.pem"
      TLS_CA_CERT_FILE: "/app/tls/ca-cert.pem"  # Для валидации storage-element server cert
      TLS_PROTOCOL_VERSION: "TLSv1.3"
      TLS_CIPHERS: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
      TLS_VERIFY_MODE: "CERT_OPTIONAL"  # Accept но не require client certs

      # CORS Configuration
      CORS_ENABLED: "true"
      CORS_ALLOW_ORIGINS: '["https://localhost:4200", "https://localhost:8000"]'

      ENVIRONMENT: "development"

    volumes:
      # Mount server certificates (для incoming HTTPS requests)
      - ./tls-infrastructure/server-certs/query-module/server-cert.pem:/app/tls/server-cert.pem:ro
      - ./tls-infrastructure/server-certs/query-module/server-key.pem:/app/tls/server-key.pem:ro

      # Mount client certificate (для outgoing mTLS requests к storage-element)
      - ./tls-infrastructure/client-certs/query-client/client-cert.pem:/app/tls/client-cert.pem:ro
      - ./tls-infrastructure/client-certs/query-client/client-key.pem:/app/tls/client-key.pem:ro

      # Mount CA certificate (для валидации storage-element server cert)
      - ./tls-infrastructure/ca/ca-cert.pem:/app/tls/ca-cert.pem:ro

    networks:
      - artstore_network
    depends_on:
      - postgres
      - redis
      - storage-element
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "--cacert", "/app/tls/ca-cert.pem", "https://localhost:8030/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # PostgreSQL Database (unchanged)
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: artstore_postgres_tls
    environment:
      POSTGRES_USER: artstore
      POSTGRES_PASSWORD: password
      POSTGRES_DB: artstore
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - artstore_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U artstore"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Redis (unchanged)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: artstore_redis_tls
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - artstore_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

# ============================================
# Networks
# ============================================
networks:
  artstore_network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  storage_data:
    driver: local
  wal_data:
    driver: local
