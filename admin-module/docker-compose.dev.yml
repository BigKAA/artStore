# Admin Module Development Docker Compose
# Использует инфраструктуру из глобального /home/artur/Projects/artStore/docker-compose.yml
# Режим разработки с hot-reload и debugging

version: '3.8'

services:
  admin-module-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: artstore_admin_module_dev
    restart: unless-stopped
    ports:
      - "8000:8000"  # Application
      - "5678:5678"  # Debugpy
    environment:
      # Database Configuration (использует глобальный postgres)
      DB_HOST: artstore_postgres
      DB_PORT: 5432
      DB_USERNAME: artstore
      DB_PASSWORD: password
      DB_DATABASE: artstore_admin

      # Redis Configuration (использует глобальный redis)
      REDIS_HOST: artstore_redis
      REDIS_PORT: 6379

      # LDAP Configuration (использует глобальный ldap)
      LDAP_ENABLED: "true"
      LDAP_SERVER: "ldap://artstore_ldap:3389"
      LDAP_BIND_DN: "cn=Directory Manager"
      LDAP_BIND_PASSWORD: "password"
      LDAP_BASE_DN: "dc=artstore,dc=local"

      # JWT Configuration
      JWT_PRIVATE_KEY_PATH: "/app/.keys/private_key.pem"
      JWT_PUBLIC_KEY_PATH: "/app/.keys/public_key.pem"
      JWT_ALGORITHM: "RS256"
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 30
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: 7

      # Application Configuration (Development)
      APP_NAME: "ArtStore Admin Module (Dev)"
      APP_VERSION: "0.1.0-dev"
      APP_DEBUG: "true"
      APP_HOST: "0.0.0.0"
      APP_PORT: 8000

      # Logging (Development)
      LOG_LEVEL: "DEBUG"
      LOG_FORMAT: "text"

      # Development specific
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"

    volumes:
      # Source code (для hot-reload)
      - ./app:/app/app:ro
      # Tests
      - ./tests:/app/tests:ro
      # JWT ключи (read-only)
      - ./.keys:/app/.keys:ro
      # Конфигурация (read-only)
      - ./config.yaml:/app/config.yaml:ro

    networks:
      - artstore_network

    # Development command с reload и debug logging
    command: >
      uvicorn app.main:app
      --host 0.0.0.0 --port 8000
      --reload --reload-dir /app/app
      --log-level debug

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/live"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

# Использует существующую сеть из глобального docker-compose.yml
networks:
  artstore_network:
    external: true
