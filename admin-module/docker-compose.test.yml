version: '3.8'

# ==========================================
# Docker Compose для Admin Module Tests
# ==========================================
# Изолированное тестовое окружение для unit
# и integration tests Admin Module
# ==========================================

services:
  # ==========================================
  # Test PostgreSQL Database
  # ==========================================
  postgres-test:
    image: postgres:15-alpine
    container_name: admin-test-postgres
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: admin_test
    ports:
      - "5433:5432"  # Отдельный порт для тестов, не конфликтует с dev
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d admin_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - admin-test-network

  # ==========================================
  # Test Redis
  # ==========================================
  redis-test:
    image: redis:7-alpine
    container_name: admin-test-redis
    ports:
      - "6380:6379"  # Отдельный порт для тестов, не конфликтует с dev
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - admin-test-network

  # ==========================================
  # Test Runner - выполняет pytest с coverage
  # ==========================================
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: test  # Multi-stage build test target
    container_name: admin-test-runner
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      # Test database configuration
      DATABASE_HOST: postgres-test
      DATABASE_PORT: 5432
      DATABASE_USER: test_user
      DATABASE_PASSWORD: test_password
      DATABASE_NAME: admin_test

      # Test Redis configuration
      REDIS_HOST: redis-test
      REDIS_PORT: 6379

      # Test-specific settings
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text  # Human-readable для test debugging
      TESTING: "true"

      # Initial test service account
      INITIAL_ACCOUNT_ENABLED: "true"
      INITIAL_ACCOUNT_NAME: test-admin-service
      INITIAL_CLIENT_ID: test-client-id
      INITIAL_CLIENT_SECRET: test-client-secret
      INITIAL_ACCOUNT_ROLE: ADMIN

      # JWT configuration - test keys будут сгенерированы в контейнере
      JWT_ALGORITHM: RS256
      JWT_PRIVATE_KEY_PATH: /app/.keys/test_private_key.pem
      JWT_PUBLIC_KEY_PATH: /app/.keys/test_public_key.pem
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 30
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: 7
    volumes:
      # Mount source code для live testing
      - ./app:/app/app:ro
      - ./tests:/app/tests:ro
      # Mount test coverage output
      - ./htmlcov:/app/htmlcov
      - ./.coverage:/app/.coverage
    networks:
      - admin-test-network
    command: >
      sh -c "
        echo 'Waiting for database initialization...' &&
        sleep 2 &&
        echo 'Generating test JWT keys...' &&
        mkdir -p /app/.keys &&
        openssl genrsa -out /app/.keys/test_private_key.pem 2048 &&
        openssl rsa -in /app/.keys/test_private_key.pem -pubout -out /app/.keys/test_public_key.pem &&
        echo 'Running database migrations...' &&
        alembic upgrade head &&
        echo 'Running unit and integration tests with coverage...' &&
        pytest tests/unit/ tests/integration/ -v --cov=app --cov-report=html --cov-report=term &&
        echo 'Test execution complete!'
      "

# ==========================================
# Test Volumes
# ==========================================
volumes:
  postgres-test-data:
    name: admin-test-postgres-data

# ==========================================
# Test Network (isolated)
# ==========================================
networks:
  admin-test-network:
    name: admin-test-network
    driver: bridge
