# ==============================================================================
# ArtStore Development Override
# ==============================================================================
# Development-specific настройки для hot-reload и debugging.
# Переопределяет production настройки из docker-compose.backend.yml.
#
# Использование:
#   docker-compose -f docker-compose.infrastructure.yml \
#                  -f docker-compose.backend.yml \
#                  -f docker-compose.dev.yml \
#                  up --build
#
# Остановка:
#   docker-compose -f docker-compose.infrastructure.yml \
#                  -f docker-compose.backend.yml \
#                  -f docker-compose.dev.yml \
#                  down
#
# ВАЖНО: НЕ использовать в production! Только для development.
# ==============================================================================

version: '3.8'

services:
  # ==============================================================================
  # Admin Module - Development Override
  # ==============================================================================
  admin-module:
    environment:
      # Development режим
      APP_DEBUG: "on"
      ENVIRONMENT: development

      # Text logging для удобства чтения в консоли
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text

      # Uvicorn hot-reload
      SERVER_RELOAD: "on"
      SERVER_WORKERS: "1"  # Single worker для debugging

      # CORS для frontend разработки
      CORS_ALLOW_ORIGINS: '["http://localhost:4200","http://localhost:8000","http://localhost:3000"]'

    volumes:
      # Hot-reload source code
      - ./admin-module/app:/app/app:rw
      # Конфигурация
      - ./admin-module/config.yaml:/app/config.yaml:rw
      # Логи для debugging
      - ./admin-module/logs:/app/logs:rw

    # Порты для debugger (PyCharm, VS Code)
    ports:
      - "8000:8000"
      - "5678:5678"  # debugpy port

    # Отключаем resource limits для development
    deploy:
      resources:
        limits: {}
        reservations: {}

  # ==============================================================================
  # Storage Element 01 - Development Override
  # ==============================================================================
  storage-element-01:
    environment:
      APP_DEBUG: "on"
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text
      SERVER_RELOAD: "on"
      SERVER_WORKERS: "1"

    volumes:
      # Hot-reload source code
      - ./storage-element/app:/app/app:rw
      # Local storage для debugging
      - ./storage-element/data/storage:/app/.data/storage:rw
      # Логи
      - ./storage-element/logs:/app/logs:rw
      # JWT keys directory (монтируем всю директорию)
      - ./admin-module/.keys:/app/.keys:ro

    ports:
      - "8010:8010"
      - "5679:5678"  # debugpy port

    deploy:
      resources:
        limits: {}
        reservations: {}

  # ==============================================================================
  # Storage Element 02 - Development Override (Optional)
  # ==============================================================================
  storage-element-02:
    environment:
      APP_DEBUG: "on"
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text
      SERVER_RELOAD: "on"
      SERVER_WORKERS: "1"

    volumes:
      - ./storage-element/app:/app/app:rw
      - ./storage-element/data/storage-02:/app/.data/storage:rw
      - ./storage-element/logs-02:/app/logs:rw
      # JWT keys directory (монтируем всю директорию)
      - ./admin-module/.keys:/app/.keys:ro

    ports:
      - "8011:8011"
      - "5680:5678"  # debugpy port

    deploy:
      resources:
        limits: {}
        reservations: {}

  # ==============================================================================
  # Ingester Module - Development Override
  # ==============================================================================
  ingester-module:
    environment:
      APP_DEBUG: "on"
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text

    volumes:
      # Hot-reload source code
      - ./ingester-module/app:/app/app:rw
      # Логи
      - ./ingester-module/logs:/app/logs:rw
      # JWT keys directory (монтируем всю директорию)
      - ./admin-module/.keys:/app/.keys:ro

    ports:
      - "8020:8020"
      - "5681:5678"  # debugpy port

    deploy:
      resources:
        limits: {}
        reservations: {}

  # ==============================================================================
  # Query Module - Development Override
  # ==============================================================================
  query-module:
    environment:
      DEBUG: "on"
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text

    volumes:
      # Hot-reload source code
      - ./query-module/app:/app/app:rw
      # Логи
      - ./query-module/logs:/app/logs:rw
      # JWT keys directory (монтируем всю директорию)
      - ./admin-module/.keys:/app/.keys:ro

    ports:
      - "8030:8030"
      - "5682:5678"  # debugpy port

    deploy:
      resources:
        limits: {}
        reservations: {}

  # ==============================================================================
  # PostgreSQL - Development Override
  # ==============================================================================
  postgres:
    environment:
      # Более подробное логирование для debugging
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"

    # БЕЗ persistent volumes - для быстрой очистки при разработке
    volumes:
      # ТОЛЬКО init script, БЕЗ data volume
      - ./scripts/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro

    # Открываем порт для прямого доступа из IDE
    ports:
      - "5432:5432"

  # ==============================================================================
  # Redis - Development Override
  # ==============================================================================
  redis:
    # БЕЗ persistent data для development
    volumes: []

    # Redis без AOF persistence для быстрой очистки
    command: >
      redis-server
      --appendonly no
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

  # ==============================================================================
  # MinIO - Development Override
  # ==============================================================================
  minio:
    # БЕЗ persistent data
    volumes: []

    environment:
      # Development credentials (НЕ безопасно для production!)
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin

# ==============================================================================
# DEVELOPMENT NOTES
# ==============================================================================
# 1. Text logging для удобства чтения в консоли
# 2. Hot-reload через монтирование ./app директорий
# 3. Debug ports 5678-5682 для PyCharm/VS Code remote debugging
# 4. БЕЗ persistent volumes для быстрой очистки (docker-compose down -v)
# 5. Single worker для упрощенного debugging
# 6. CORS разрешены для localhost портов frontend разработки
# 7. БЕЗ resource limits для максимальной производительности при отладке
#
# Пример подключения debugger (VS Code launch.json):
# {
#   "name": "Python: Attach to Admin Module",
#   "type": "python",
#   "request": "attach",
#   "connect": {
#     "host": "localhost",
#     "port": 5678
#   },
#   "pathMappings": [
#     {
#       "localRoot": "${workspaceFolder}/admin-module/app",
#       "remoteRoot": "/app/app"
#     }
#   ]
# }
#
# Быстрая очистка всех данных:
#   docker-compose -f docker-compose.infrastructure.yml \
#                  -f docker-compose.backend.yml \
#                  -f docker-compose.dev.yml \
#                  down -v
#
# Пересборка после изменений в Dockerfile:
#   docker-compose -f docker-compose.infrastructure.yml \
#                  -f docker-compose.backend.yml \
#                  -f docker-compose.dev.yml \
#                  up --build -d
# ==============================================================================
