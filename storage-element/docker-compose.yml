version: '3.8'

services:
  # ==========================================
  # Storage Element Application
  # ==========================================
  storage-element:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: artstore_storage_element
    restart: unless-stopped
    ports:
      - "8010:8010"
    environment:
      # Application
      APP_NAME: "Storage Element 01"
      APP_VERSION: "0.1.0"
      APP_DEBUG: "true"
      APP_MODE: "edit"  # edit, rw, ro, ar

      # Server
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "8010"
      SERVER_RELOAD: "true"
      SERVER_WORKERS: "1"

      # Database - using shared infrastructure
      DB_HOST: artstore_postgres
      DB_PORT: 5432
      DB_USERNAME: artstore
      DB_PASSWORD: password
      DB_DATABASE: artstore_storage_01
      DB_TABLE_PREFIX: storage_elem_01
      DB_POOL_SIZE: 10
      DB_MAX_OVERFLOW: 20

      # Redis - using shared infrastructure
      REDIS_HOST: artstore_redis
      REDIS_PORT: 6379
      REDIS_DB: 0

      # JWT
      JWT_ALGORITHM: "RS256"
      JWT_PUBLIC_KEY_PATH: "/app/.keys/public_key.pem"

      # Storage
      STORAGE_TYPE: "local"  # local или s3
      STORAGE_LOCAL_BASE_PATH: "/app/.data/storage"
      STORAGE_MAX_FILE_SIZE: "1073741824"  # 1GB

      # S3 (если STORAGE_TYPE=s3) - using shared minio
      # STORAGE_S3_ENDPOINT_URL: "http://artstore_minio:9000"
      # STORAGE_S3_ACCESS_KEY: "minioadmin"
      # STORAGE_S3_SECRET_KEY: "minioadmin"
      # STORAGE_S3_BUCKET_NAME: "artstore-storage-01"
      # STORAGE_S3_REGION: "us-east-1"

      # Logging
      LOG_LEVEL: "DEBUG"
      LOG_FORMAT: "text"  # text для dev, json для production

      # Metrics
      METRICS_ENABLED: "true"
      METRICS_PATH: "/metrics"

      # Health
      HEALTH_LIVENESS_PATH: "/health/live"
      HEALTH_READINESS_PATH: "/health/ready"
    volumes:
      # Persistent storage
      - ./data/storage:/app/.data/storage
      # JWT public key (должен быть скопирован из admin-module)
      - ../admin-module/.keys/public_key.pem:/app/.keys/public_key.pem:ro
      # Code для hot-reload (только для dev)
      - ./app:/app/app
    networks:
      - artstore_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==========================================
# External Network (defined in root docker-compose.yml)
# ==========================================
networks:
  artstore_network:
    external: true
