version: '3.8'

services:
  ingester-module:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: artstore_ingester
    ports:
      - "8020:8020"
    environment:
      # App Settings
      - APP_NAME=artstore-ingester
      - APP_VERSION=0.1.0
      - APP_DEBUG=true
      - APP_HOST=0.0.0.0
      - APP_PORT=8020

      # Auth Settings
      - AUTH_ENABLED=true
      - AUTH_PUBLIC_KEY_PATH=/app/keys/public_key.pem
      - AUTH_ALGORITHM=RS256

      # Service Account Settings (OAuth 2.0 Client Credentials)
      - SERVICE_ACCOUNT_CLIENT_ID=sa_prod_ingester_module_11cafd4f
      - SERVICE_ACCOUNT_CLIENT_SECRET=:hC%=#>a9q,GwunR
      - SERVICE_ACCOUNT_ADMIN_MODULE_URL=http://artstore_admin_module:8000
      - SERVICE_ACCOUNT_TIMEOUT=10

      # Storage Element Settings
      - STORAGE_ELEMENT_BASE_URL=http://artstore_storage_element:8010
      - STORAGE_ELEMENT_TIMEOUT=30
      - STORAGE_ELEMENT_MAX_RETRIES=3
      - STORAGE_ELEMENT_CONNECTION_POOL_SIZE=100

      # Redis Settings (использует redis из корневого docker-compose.yml)
      - REDIS_HOST=artstore_redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_MAX_CONNECTIONS=50

      # Compression Settings
      - COMPRESSION_ENABLED=true
      - COMPRESSION_ALGORITHM=gzip
      - COMPRESSION_LEVEL=6
      - COMPRESSION_MIN_SIZE=1024

      # Logging Settings
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=text
    volumes:
      # Монтирование публичного ключа для JWT
      - ../admin-module/keys:/app/keys:ro
      # Volume для логов (опционально)
      - ./logs:/app/logs
    networks:
      - artstore_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8020/api/v1/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  artstore_network:
    external: true

# Примечания:
# - Redis, PostgreSQL, MinIO и другие инфраструктурные сервисы запускаются
#   через корневой docker-compose.yml в /home/artur/Projects/artStore/
# - Storage Element должен быть запущен отдельно через docker-compose
#   в директории storage-element/
# - Admin Module должен быть запущен для генерации JWT ключей
