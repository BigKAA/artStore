version: '3.8'

services:
  # Test PostgreSQL database - isolated from development
  postgres-test:
    image: postgres:15-alpine
    container_name: ingester-test-postgres
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: ingester_test
    ports:
      - "5433:5432"  # Different port to avoid conflict with dev
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d ingester_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # Test Redis - isolated from development
  redis-test:
    image: redis:7-alpine
    container_name: ingester-test-redis
    ports:
      - "6380:6379"  # Different port to avoid conflict with dev
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  # Test runner - runs pytest with all dependencies
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: test  # Multi-stage build test target
    container_name: ingester-test-runner
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      # Test database configuration
      DATABASE_HOST: postgres-test
      DATABASE_PORT: 5432
      DATABASE_USER: test_user
      DATABASE_PASSWORD: test_password
      DATABASE_NAME: ingester_test

      # Test Redis configuration
      REDIS_HOST: redis-test
      REDIS_PORT: 6379

      # Test-specific settings
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text  # Human-readable for test debugging
      TESTING: "true"

      # Mock external services
      ADMIN_MODULE_URL: http://mock-admin:8000
      STORAGE_ELEMENT_URL: http://mock-storage:8010
    volumes:
      # Mount source code for live testing
      - ./app:/app/app:ro
      - ./tests:/app/tests:ro
      # Mount test coverage output
      - ./htmlcov:/app/htmlcov
      - ./.coverage:/app/.coverage
    networks:
      - test-network
    command: >
      sh -c "
        echo 'Waiting for database initialization...' &&
        sleep 2 &&
        echo 'Running database migrations...' &&
        alembic upgrade head &&
        echo 'Running unit tests with coverage...' &&
        pytest tests/unit/ -v --cov=app --cov-report=html --cov-report=term &&
        echo 'Test execution complete!'
      "

  # Mock Admin Module for integration tests (future)
  mock-admin:
    image: mockserver/mockserver:latest
    container_name: ingester-test-mock-admin
    ports:
      - "8001:8000"
    environment:
      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/admin-mock.json
    volumes:
      - ./tests/mocks/admin-mock.json:/config/admin-mock.json:ro
    networks:
      - test-network
    profiles:
      - integration  # Only start for integration tests

  # Mock Storage Element for integration tests (future)
  mock-storage:
    image: mockserver/mockserver:latest
    container_name: ingester-test-mock-storage
    ports:
      - "8011:8010"
    environment:
      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/storage-mock.json
    volumes:
      - ./tests/mocks/storage-mock.json:/config/storage-mock.json:ro
    networks:
      - test-network
    profiles:
      - integration  # Only start for integration tests

volumes:
  postgres-test-data:
    name: ingester-test-postgres-data

networks:
  test-network:
    name: ingester-test-network
    driver: bridge
