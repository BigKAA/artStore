---
# Ingress для ArtStore (Nginx Ingress Controller)
# Предоставляет единую точку входа для всех модулей
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: artstore-ingress
  namespace: artstore
  labels:
    app: artstore
    component: ingress
  annotations:
    # Nginx Ingress Controller аннотации
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "false"  # Для production установить "true" с TLS
    nginx.ingress.kubernetes.io/proxy-body-size: "1024m"  # Максимум 1GB для файлов
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"  # Отключить буферизацию для streaming

    # CORS headers
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"  # В production указать конкретные домены
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # Rate limiting (опционально)
    # nginx.ingress.kubernetes.io/limit-rps: "100"

    # TLS Configuration (раскомментировать при использовании cert-manager)
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: system-ingress  # Использовать Nginx Ingress Controller

  # TLS Configuration (раскомментировать в production)
  # tls:
  #   - hosts:
  #       - artstore.example.com
  #     secretName: artstore-tls

  rules:
    - host: artstore.kryukov.local  # ИЗМЕНИТЬ на актуальный домен!
      http:
        paths:
          # Admin Module - OAuth 2.0 authentication и управление
          - path: /api/admin(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: admin-module
                port:
                  number: 8000

          # Storage Element - физическое хранение файлов
          - path: /api/storage(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: storage-element
                port:
                  number: 8010

          # Ingester Module - загрузка файлов
          - path: /api/ingester(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: ingester-module
                port:
                  number: 8020

          # Query Module - поиск и скачивание файлов
          - path: /api/query(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: query-module
                port:
                  number: 8030

          # Prometheus - мониторинг
          - path: /prometheus(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: prometheus
                port:
                  number: 9090

          # Grafana - дашборды
          - path: /grafana(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: grafana
                port:
                  number: 3000

---
# Дополнительный Ingress для MinIO Console (опционально)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minio-console-ingress
  namespace: artstore
  labels:
    app: minio
    component: infrastructure
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "1024m"
spec:
  ingressClassName: nginx
  rules:
    - host: artstore.example.com
      http:
        paths:
          # MinIO Console
          - path: /minio-console(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: minio
                port:
                  number: 9001
